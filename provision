#!/usr/bin/env sh
set -eu

. "$(dirname "${0}")/lib/lib-loader.sh"
load_libs "$(dirname "${0}")/lib"

BUCKET_NAME=""
SUBDOMAIN=""
HOSTED_ZONE_ID=""
STACK_NAME=""
ENABLE_CANONICAL_URIS=""
ROOT_DOMAIN_NAME=""
ENABLE_SECURITY_HEADERS=""
CONTENT_SECURITY_POLICY=""
TAGS=""

usage() {
	style bold <<-EOF
		${RESET}Usage: $0 [options] <site-name>

		${RESET}Creates a new AWS CloudFormation stack to provision a static website.

		${RESET}Options:
		  -b, --bucket-name <name>    ${RESET}Specify a custom bucket name.
		  -s, --subdomain <name>      ${RESET}Specify a subdomain.
		  -z, --hosted-zone-id <ID>   ${RESET}Use an existing Hosted Zone ID instead of creating one.
		  -n, --stack-name <name>     ${RESET}Specify a custom CloudFormation stack name.
		  -nc, --no-canonical-uris    ${RESET}Disable URI canonicalization (See ./README.md for more details).
		  --no-security-headers       ${RESET}Disable the default security headers.
		  --csp-policy <policy>       ${RESET}Specify a custom Content Security Policy (CSP) for the site.
		                              ${RESET}${DIM}Default is "frame-ancestors 'self';".
		  -t, --tag <tag>             ${RESET}Add a tag (format: key=value).
		  --tags <tags>               ${RESET}Add multiple tags (format: "key1=value1 key2=value2").
		                              ${RESET}${DIM}Note: --tag and --tags can be combined and used multiple times.
		  -h, --help                  ${RESET}Display this help message.
	EOF
}

check_dependencies

# Parse Arguments
POSITIONAL_ARGS=""
while [ "$#" -gt 0 ]; do
	current_arg="$1"
	next_arg="${2-}"

	case "$current_arg" in
	-b | --bucket-name)
		require_argument "$current_arg" "$next_arg"
		warn_if_conflict "--bucket-name" "$BUCKET_NAME"
		BUCKET_NAME="$next_arg"
		shift
		;;
	-s | --subdomain)
		require_argument "$current_arg" "$next_arg"
		warn_if_conflict "--subdomain" "$SUBDOMAIN"
		SUBDOMAIN="$next_arg"
		shift
		;;
	-z | --hosted-zone-id)
		require_argument "$current_arg" "$next_arg"
		warn_if_conflict "--hosted-zone-id" "$HOSTED_ZONE_ID"
		HOSTED_ZONE_ID="$next_arg"
		shift
		;;
	-n | --stack-name)
		require_argument "$current_arg" "$next_arg"
		warn_if_conflict "--stack-name" "$STACK_NAME"
		STACK_NAME="$next_arg"
		shift
		;;
	-t | --tag | --tags)
		require_argument "$current_arg" "$next_arg"
		TAGS="${TAGS:+$TAGS }${next_arg}"
		shift
		;;
	-nc | --no-canonical-uris)
		ENABLE_CANONICAL_URIS="false"
		;;
	--no-security-headers)
		warn_if_conflict "--csp-policy" "$CONTENT_SECURITY_POLICY" "CSP policy will not be applied when security headers are disabled"
		ENABLE_SECURITY_HEADERS="false"
		;;
	--csp-policy)
		require_argument "$current_arg" "$next_arg"
		warn_if_conflict "--csp-policy" "$CONTENT_SECURITY_POLICY"
		warn_if_conflict "--no-security-headers" "$ENABLE_SECURITY_HEADERS" "CSP policy will not be applied when security headers are disabled"
		CONTENT_SECURITY_POLICY="$next_arg"
		;;
	-h | --help)
		usage
		exit 0
		;;
	-*)
		style red "Unknown option: $current_arg" >&2
		usage
		exit 1
		;;
	*)
		POSITIONAL_ARGS="${POSITIONAL_ARGS:+$POSITIONAL_ARGS }${current_arg}"
		;;
	esac
	shift
done

# shellcheck disable=SC2086
set -- $POSITIONAL_ARGS
unset POSITIONAL_ARGS

# Set positional arguments
ROOT_DOMAIN_NAME="${1}"

# Validate required arguments
if [ -z "$ROOT_DOMAIN_NAME" ]; then
	style red "Error: Missing required argument: <site-name>" >&2
	usage
	exit 1
fi

# Set default values for optional arguments
FULL_DOMAIN_NAME="${SUBDOMAIN:+${SUBDOMAIN}.}${ROOT_DOMAIN_NAME}"
: "${STACK_NAME:=$(printf '%s' "$FULL_DOMAIN_NAME" | tr -s -c 'a-zA-Z0-9-' '-')}"
: "${BUCKET_NAME:=$FULL_DOMAIN_NAME}"
: "${ENABLE_CANONICAL_URIS:=true}"
: "${ENABLE_SECURITY_HEADERS:=true}"
: "${CONTENT_SECURITY_POLICY:=frame-ancestors 'self';}"

print_config() {
	if [ "$ENABLE_SECURITY_HEADERS" = "true" ]; then
		CSP_DISPLAY_VALUE="$CONTENT_SECURITY_POLICY"
	else
		CSP_DISPLAY_VALUE="${DIM}(disabled)${RESET}"
	fi

	style blue <<-EOF
		${BOLD}Configuration Summary
		  Root Domain Name:           ${RESET}$ROOT_DOMAIN_NAME
		  Subdomain:                  ${RESET}${SUBDOMAIN:-"${DIM}(none)${RESET}"}
		  Bucket Name:                ${RESET}${BUCKET_NAME}
		  Hosted Zone ID:             ${RESET}${HOSTED_ZONE_ID:-"${DIM}(to be created)${RESET}"}
		  CloudFormation Stack Name:  ${RESET}${STACK_NAME}
		  Canonical URIs:             ${RESET}${ENABLE_CANONICAL_URIS}
		  Security Headers:           ${RESET}${ENABLE_SECURITY_HEADERS}
		  Content Security Policy:    ${RESET}${CSP_DISPLAY_VALUE}
		  Tags:                       ${RESET}${TAGS:-"${DIM}(none)${RESET}"}
	EOF
}

deploy_dns_stack() {
	style "Deploying DNS stack for ${ROOT_DOMAIN_NAME}"
	aws cloudformation deploy \
		--stack-name "${STACK_NAME}-dns" \
		--template-file cloudformation/dns.yml \
		--parameter-overrides \
			"RootDomainName=${ROOT_DOMAIN_NAME}" \
			"HostedZoneId=${HOSTED_ZONE_ID:-}" \
		${TAGS:+--tags $TAGS} \
		| style dim

	nameservers=$(aws cloudformation describe-stacks \
		--stack-name "${STACK_NAME}-dns" \
		--query "Stacks[0].Outputs[?OutputKey=='NameServers'].OutputValue" \
		--output text)

	if [ -n "$nameservers" ]; then
		style yellow <<-EOF
		${BOLD}Potential Action Required:
		Make sure your domain registrar has the following nameservers set for your domain:

		${nameservers}
		EOF
	fi
}

deploy_site_stack() {
	style "Deploying site stack for ${ROOT_DOMAIN_NAME}"
	aws cloudformation deploy \
		--stack-name "${STACK_NAME}" \
		--template-file cloudformation/site.yml \
		--parameter-overrides \
			"RootDomainName=${ROOT_DOMAIN_NAME}" \
			"BucketName=${BUCKET_NAME}" \
			"HostedZoneIdImportName=${STACK_NAME}-dns-HostedZoneId" \
			"Subdomain=${SUBDOMAIN:-}" \
			"EnableCanonicalURIs=${ENABLE_CANONICAL_URIS}" \
			"EnableSecurityHeaders=${ENABLE_SECURITY_HEADERS}" \
			"ContentSecurityPolicy=${CONTENT_SECURITY_POLICY}" \
		${TAGS:+--tags $TAGS} \
		| style dim
}

display_outputs() {
	style bold blue "Stack outputs for ${STACK_NAME}"
	aws cloudformation describe-stacks \
		--stack-name "${STACK_NAME}" \
		--query "Stacks[0].Outputs[*].[OutputKey,OutputValue]" \
		--no-cli-pager \
		--output text | while read -r key value; do
			printf "  ${BLUE}%s:${RESET} %s\n" "$key" "$value"
		done
}

# Main execution
print_config
style blue bold "Provisioning for ${FULL_DOMAIN_NAME}"
deploy_dns_stack
deploy_site_stack
display_outputs
style green "Provisioning complete for ${FULL_DOMAIN_NAME}!"
